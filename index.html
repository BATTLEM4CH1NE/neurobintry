<!DOCTYPE ahtml>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroBin - Mobile Waste Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 2rem;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            align-items: flex-start; /* Align content to the top */
            justify-content: center;
            padding: 1rem;
            width: 100%;
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone.drag-over {
            background-color: #f3f4f6;
            border-color: #4f46e5;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-overlay.visible {
            display: flex;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .waste-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="app-container max-w-xl mx-auto">
        
        <!-- Header -->
        <header class="w-full p-4 bg-white shadow-md rounded-b-xl mb-4">
            <h1 class="text-3xl font-bold text-gray-900 text-center">NeuroBin ♻️</h1>
            <p class="text-center text-sm text-gray-600 mt-1">Mobile Waste Classifier</p>
        </header>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="w-full">
                
                <!-- Classification Card -->
                <div id="classification-card" class="bg-white p-6 rounded-xl card transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">1. Upload Item for Classification</h2>
                    
                    <!-- Drop Zone / File Input -->
                    <div id="drop-zone" class="drop-zone p-8 text-center cursor-pointer rounded-xl mb-4 hover:border-indigo-500 hover:bg-indigo-50">
                        <input type="file" id="file-input" accept="image/*" class="hidden">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.885-3.376M14 16h2a4 4 0 004-4v-4m-12 12l-4-4m4 4l4-4m-4 4V7m4 4l4-4m-4 4l-4-4"></path></svg>
                        <p class="mt-2 text-sm text-gray-600">Drag & drop or <span class="text-indigo-600 font-medium">click to browse</span></p>
                        <p class="text-xs text-gray-500">PNG, JPG, up to 4MB</p>
                    </div>

                    <!-- Image Preview Area -->
                    <div id="image-preview-container" class="hidden mb-4 relative rounded-lg overflow-hidden">
                        <img id="image-preview" class="w-full h-48 object-cover object-center" alt="Image Preview">
                        <button onclick="resetApp()" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full shadow-lg hover:bg-red-600 transition duration-150">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Classification Button -->
                    <button id="classify-button" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-150 shadow-md shadow-indigo-200 disabled:opacity-50" disabled>
                        Classify Waste Item
                    </button>
                    
                    <!-- Status/Error Message -->
                    <p id="status-message" class="mt-3 text-center text-sm font-medium hidden"></p>

                </div>

                <!-- Result Card -->
                <div id="result-card" class="bg-white p-6 rounded-xl card mt-6 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">2. Classification Result</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="text-gray-600 font-medium">Type:</span>
                            <span id="result-type" class="waste-type-badge bg-green-100 text-green-800"></span>
                        </div>
                        <div class="border-b pb-2">
                            <span class="text-gray-600 font-medium block mb-1">How to Dispose:</span>
                            <p id="result-disposal" class="text-gray-800 text-sm"></p>
                        </div>
                        <div>
                            <span class="text-gray-600 font-medium block mb-1">Environmental Tip:</span>
                            <p id="result-tip" class="text-gray-800 text-sm italic"></p>
                        </div>
                    </div>
                </div>

                <!-- History Section -->
                <div id="history-container" class="w-full mt-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">3. Classification History (User ID: <span id="user-id-display" class="font-mono text-sm bg-gray-200 px-2 py-0.5 rounded">...</span>)</h2>
                    <div id="history-list" class="space-y-3">
                        <!-- History items will be inserted here -->
                        <p id="loading-history" class="text-center text-gray-500">Loading history...</p>
                    </div>
                    <p id="empty-history" class="text-center text-gray-500 mt-4 hidden">No classification history found yet!</p>
                </div>

            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loader"></div>
        </div>

        <!-- Custom Error Modal (Used instead of alert()) -->
        <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[2000]">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-11/12">
                <h3 class="text-xl font-bold text-red-600 mb-3">Error</h3>
                <p id="error-modal-message" class="text-gray-700 mb-4"></p>
                <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports (Updated to v12.3.0) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { 
            getFirestore, 
            addDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js"; 
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";

        // Set Firebase debug log level
        setLogLevel('Debug');
        
        // --- HARDCODED FALLBACK CONFIGURATION (Using user's provided, updated configuration) ---
        const USER_FIREBASE_CONFIG_FALLBACK = {
            apiKey: "AIzaSyAsyIFdxENdIbDCvvF1RJH7v_ea1mmBcsw",
            authDomain: "neurobin-60a06.firebaseapp.com",
            databaseURL: "https://neurobin-60a06-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "neurobin-60a06",
            storageBucket: "neurobin-60a06.firebasestorage.app",
            messagingSenderId: "284735902537",
            appId: "1:284735902537:web:a9ba65110cacda5cad0098", 
            measurementId: "G-T9F21LK4ZE" 
        };

        // --- Global Variables ---
        let app, db, auth, userId;
        let selectedFile = null;

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Robust Configuration Loading
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                // Attempt to parse the environment variable string
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse __firebase_config, falling back to user-provided config.", e);
                firebaseConfig = USER_FIREBASE_CONFIG_FALLBACK;
            }
        } else {
            console.warn("__firebase_config not provided by environment. Using hardcoded configuration.");
            firebaseConfig = USER_FIREBASE_CONFIG_FALLBACK;
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const LLM_API_KEY = ""; // Empty string for Canvas environment API Key handling

        // --- Utility Functions ---

        /** Shows a custom error modal */
        function showError(message) {
            const modal = document.getElementById('error-modal');
            document.getElementById('error-modal-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        /** Shows or hides the loading overlay */
        function setLoading(isLoading) {
            const overlay = document.getElementById('loading-overlay');
            if (isLoading) {
                overlay.classList.add('visible');
            } else {
                overlay.classList.remove('visible');
            }
        }

        /** Converts a File object to a base64 string */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Extract only the base64 data part (after the comma)
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // --- Core Application Logic ---
        
        /** Initializes Firebase and authenticates the user */
        async function initFirebaseAndAuth() {
            // CRITICAL CHECK: Ensure minimum required fields for Auth are present
            if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId) {
                console.error("Critical Firebase Configuration Missing:", firebaseConfig);
                showError("Firebase setup failed: The configuration object is incomplete. Please ensure API Key, Auth Domain, and Project ID are included.");
                return;
            }

            try {
                // Initialize the app instance
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                
                // Sign in with the provided token or anonymously
                const authPromise = initialAuthToken 
                    ? signInWithCustomToken(auth, initialAuthToken)
                    : signInAnonymously(auth);

                await authPromise;


                // Listen for auth state changes to set the user ID and start history listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        // Once authenticated, start listening to history
                        setupHistoryListener();
                    } else {
                        userId = 'unauthenticated';
                        document.getElementById('user-id-display').textContent = userId;
                        // Only show error if no token was provided, otherwise it's just anonymous sign-in
                        if (initialAuthToken) {
                             showError("Failed to authenticate user with custom token. History will not be saved correctly.");
                        } else {
                            console.log("Successfully signed in anonymously.");
                        }
                    }
                    setupEventListeners();
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // Specifically targeting the auth error message
                if (error.code === 'auth/configuration-not-found') {
                    showError("Firebase setup failed: The Authentication configuration is missing required security fields. This is usually resolved by ensuring the full config is correct and Anonymous Auth is enabled.");
                } else {
                    showError(`Firebase setup failed: ${error.message}.`);
                }
            }
        }

        /** Sets up a real-time listener for the user's classification history */
        function setupHistoryListener() {
            if (!db || !userId || userId === 'unauthenticated') {
                console.warn("Firestore not initialized or userId not set. Cannot set up history listener.");
                return;
            }

            const historyCollectionPath = `/artifacts/${appId}/users/${userId}/classification_history`;
            const q = query(
                collection(db, historyCollectionPath),
                // Note: sorting is done in-memory to avoid mandatory index creation errors
            );

            // Use onSnapshot for real-time updates
            onSnapshot(q, (snapshot) => {
                const historyList = [];
                snapshot.forEach(doc => {
                    // Add document data along with its ID
                    historyList.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort the history in-memory by timestamp (descending)
                historyList.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeB - timeA;
                });

                renderHistory(historyList);

            }, (error) => {
                console.error("Firestore History Listener Error:", error);
                document.getElementById('loading-history').textContent = 'Error loading history.';
                showError("Could not load history in real-time. See console for details.");
            });
        }
        
        /** Renders the classification history list */
        function renderHistory(history) {
            const historyListEl = document.getElementById('history-list');
            const loadingEl = document.getElementById('loading-history');
            const emptyEl = document.getElementById('empty-history');
            
            historyListEl.innerHTML = '';
            loadingEl.classList.add('hidden');

            if (history.length === 0) {
                emptyEl.classList.remove('hidden');
                return;
            }

            emptyEl.classList.add('hidden');

            history.forEach(item => {
                const date = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                
                const badgeColor = getBadgeColor(item.wasteType);

                const html = `
                    <div class="bg-white p-4 rounded-xl card flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="mb-2 sm:mb-0">
                            <p class="text-xs text-gray-500">${date}</p>
                            <p class="text-sm text-gray-800 font-medium truncate max-w-xs">${item.query}</p>
                        </div>
                        <span class="waste-type-badge ${badgeColor}">${item.wasteType}</span>
                    </div>
                `;
                historyListEl.insertAdjacentHTML('beforeend', html);
            });
        }
        
        /** Gets Tailwind color classes based on waste type */
        function getBadgeColor(type) {
             const lowerType = type.toLowerCase();
             if (lowerType.includes('recyclable')) return 'bg-blue-100 text-blue-800';
             if (lowerType.includes('compost')) return 'bg-green-100 text-green-800';
             if (lowerType.includes('hazardous')) return 'bg-red-100 text-red-800';
             if (lowerType.includes('landfill') || lowerType.includes('general')) return 'bg-yellow-100 text-yellow-800';
             return 'bg-gray-100 text-gray-800';
        }

        /** Saves the classification result to Firestore */
        async function saveClassification(imageQuery, result) {
            // Only try to save if Firebase is properly initialized and we have a user ID
            if (!db || !userId || userId === 'unauthenticated') {
                console.warn("Database or User ID not available for saving result. Skipping history save.");
                return;
            }

            try {
                const historyCollectionPath = `/artifacts/${appId}/users/${userId}/classification_history`;
                await addDoc(collection(db, historyCollectionPath), {
                    query: imageQuery,
                    wasteType: result.classification,
                    disposalInstructions: result.disposal_instructions,
                    environmentalTip: result.environmental_tip,
                    timestamp: serverTimestamp() // Use server timestamp for accuracy
                });
            } catch (error) {
                console.error("Error saving classification to Firestore:", error);
                showError(`Failed to save history: ${error.message}`);
            }
        }

        /** Handles file selection and updates the UI */
        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showError("Please select a valid image file (PNG, JPG, JPEG).");
                return;
            }

            if (file.size > 4 * 1024 * 1024) { // 4MB limit
                showError("The image file is too large (max 4MB).");
                return;
            }

            selectedFile = file;
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');
            const classifyButton = document.getElementById('classify-button');
            const statusMessage = document.getElementById('status-message');

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('hidden');
                classifyButton.disabled = false;
                classifyButton.textContent = 'Classify Waste Item';
                statusMessage.classList.add('hidden');
                document.getElementById('result-card').classList.add('hidden'); // Hide result when new image is loaded
            };
            reader.readAsDataURL(file);
        }

        /** Resets the application state to allow for a new upload */
        window.resetApp = function() {
            selectedFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('image-preview').src = '';
            document.getElementById('classify-button').disabled = true;
            document.getElementById('classify-button').textContent = 'Classify Waste Item';
            document.getElementById('status-message').classList.add('hidden');
            document.getElementById('result-card').classList.add('hidden');
        }

        /** Sets up all UI event listeners */
        function setupEventListeners() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const classifyButton = document.getElementById('classify-button');

            // Click handling
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

            // Drag and drop handling
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            // Classification button click
            classifyButton.addEventListener('click', classifyImage);
        }
        
        /** Displays the LLM classification result in the UI */
        function displayResult(result) {
            const resultCard = document.getElementById('result-card');
            const resultType = document.getElementById('result-type');
            const resultDisposal = document.getElementById('result-disposal');
            const resultTip = document.getElementById('result-tip');

            if (result && result.classification) {
                resultType.textContent = result.classification;
                resultType.className = `waste-type-badge ${getBadgeColor(result.classification)}`;
                resultDisposal.textContent = result.disposal_instructions || 'N/A';
                resultTip.textContent = result.environmental_tip || 'N/A';
                resultCard.classList.remove('hidden');
                
                // Save the successful classification to Firestore
                saveClassification(selectedFile.name, result);
                
            } else {
                showError("Classification failed: The API returned an invalid result format.");
            }
        }

        /** Handles the main classification process */
        async function classifyImage() {
            if (!selectedFile) {
                showError("Please select an image first.");
                return;
            }

            // 1. Explicitly hide previous results before starting
            document.getElementById('result-card').classList.add('hidden'); 

            setLoading(true);
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = 'Classifying... please wait.';
            statusMessage.classList.remove('hidden');
            statusMessage.classList.remove('text-red-500');
            statusMessage.classList.add('text-indigo-600');

            try {
                // 2. Convert file to base64
                const base64ImageData = await fileToBase64(selectedFile);
                
                // 3. Define the LLM instructions and prompt
                const systemPrompt = "You are an expert waste classification model. Your task is to analyze the image and classify the waste item into one of four categories: Recyclable, Compostable, Landfill/General Waste, or Hazardous Waste. Provide a concise classification, disposal instructions, and a relevant environmental tip in the requested JSON format.";
                
                const userQuery = `Classify this image of waste. The item is named: "${selectedFile.name}".`;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${LLM_API_KEY}`;
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: selectedFile.type,
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "classification": {
                                    "type": "STRING",
                                    "description": "The classified waste type (e.g., Recyclable, Compostable, Landfill/General Waste, Hazardous Waste)."
                                },
                                "disposal_instructions": {
                                    "type": "STRING",
                                    "description": "Concise, actionable steps for proper disposal."
                                },
                                "environmental_tip": {
                                    "type": "STRING",
                                    "description": "A short, relevant fact or tip about reducing waste or sustainable practices."
                                }
                            },
                            "propertyOrdering": ["classification", "disposal_instructions", "environmental_tip"]
                        }
                    }
                };

                // 4. Call the Gemini API with retry logic
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Request failed with status: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const parsedJson = JSON.parse(text);
                    displayResult(parsedJson);
                    statusMessage.textContent = 'Classification successful!';
                    statusMessage.classList.remove('text-indigo-600');
                    statusMessage.classList.add('text-green-600');
                } else {
                    throw new Error("Invalid response structure or empty result from the API.");
                }

            } catch (error) {
                console.error("Classification Error:", error);
                statusMessage.textContent = 'Classification failed.';
                statusMessage.classList.remove('text-indigo-600');
                statusMessage.classList.add('text-red-500');
                showError(error.message || "An unexpected error occurred. Please try again.");
            } finally {
                setLoading(false);
            }
        }
        
        // Helper function for exponential backoff
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) {
                         // Exponentially increase delay
                         await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                         continue; // Retry with the next iteration
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    // Exponentially increase delay before next retry
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }
        
        // --- Initialization ---
        window.onload = initFirebaseAndAuth;

    </script>
</body>
</html>
