<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroBin - Mobile Waste Classifier</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8f9fa; /* Light background for the overall app */
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1; /* Fix: Corrected CSS syntax */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .drop-zone {
            border: 3px dashed #cbd5e1; /* slate-300 */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone.drag-over {
            background-color: #f0f9ff; /* sky-50 */
            border-color: #3b82f6; /* blue-500 */
        }
        .loader {
            border-top-color: #3b82f6;
            border-right-color: #3b82f6;
            border-bottom-color: transparent;
            border-left-color: transparent;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="p-4 bg-white shadow-xl z-10 sticky top-0">
            <h1 class="text-3xl font-extrabold text-center text-indigo-600">NeuroBin</h1>
            <p class="text-sm text-center text-gray-500 mt-1">AI-Powered Waste Classification</p>
        </header>

        <main class="main-content">
            <div class="w-full max-w-lg mx-auto bg-white p-6 rounded-3xl shadow-[0_10px_25px_rgba(0,0,0,0.1)] space-y-6 md:p-8">

                <!-- Input/Image Preview Section -->
                <div id="input-section">
                    <input type="file" id="file-input" accept="image/*" class="hidden">
                    
                    <!-- File Drop/Selection Zone -->
                    <div id="drop-zone" class="drop-zone flex flex-col items-center justify-center p-8 text-center rounded-2xl cursor-pointer transition" style="min-height: 180px;">
                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a4 4 0 01-4 4h-1"></path></svg>
                        <p class="mt-3 text-base text-gray-600 font-medium">Drag & drop image here, or</p>
                        <!-- FIX: Explicit Button for better UX/Accessibility -->
                        <button id="file-select-btn" class="mt-4 px-6 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition duration-200 transform hover:scale-[1.03] active:scale-95">
                            Select File
                        </button>
                    </div>

                    <button id="camera-btn" class="w-full mt-4 flex items-center justify-center space-x-2 px-4 py-3 bg-green-500 text-white font-semibold rounded-2xl shadow-lg hover:bg-green-600 transition duration-200 transform hover:scale-[1.01] active:scale-95">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.153 4h3.694a2 2 0 011.664.89l.812 1.218a2 2 0 001.664.89H21a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>Use Camera</span>
                    </button>
                </div>

                <!-- Camera/Preview Section -->
                <div id="camera-preview-section" class="hidden space-y-4">
                    <div class="relative w-full aspect-video rounded-xl overflow-hidden shadow-inner bg-gray-900">
                        <video id="camera-video" class="w-full h-full object-cover" autoplay playsinline></video>
                        <img id="image-preview" class="w-full h-full object-contain hidden" alt="Waste Preview">
                        <canvas id="camera-canvas" class="hidden"></canvas>
                    </div>

                    <div class="flex space-x-3">
                        <button id="capture-btn" class="flex-1 px-4 py-3 bg-yellow-500 text-white font-semibold rounded-2xl shadow-lg hover:bg-yellow-600 transition duration-200 transform hover:scale-[1.01] active:scale-95">
                            Capture Photo
                        </button>
                        <button id="switch-to-upload-btn" class="px-4 py-3 bg-gray-300 text-gray-800 font-semibold rounded-2xl shadow-lg hover:bg-gray-400 transition duration-200 transform hover:scale-[1.01] active:scale-95">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- Shared Action Button -->
                <button id="classify-btn" class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-2xl shadow-xl hover:bg-blue-700 transition duration-200 transform hover:scale-[1.01] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed hidden">
                    Classify Waste
                </button>

                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden flex justify-center items-center p-4">
                    <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-blue-600 loader rounded-full border-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"></svg>
                    <span class="text-blue-600 font-semibold">Analyzing waste image...</span>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-inner" role="alert">
                    <p id="error-text" class="text-sm font-medium"></p>
                </div>
                
                <!-- Result Section -->
                <div id="result-section" class="hidden bg-gray-50 p-5 rounded-2xl border border-gray-200 shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2 text-indigo-700">Classification Result</h2>
                    <div class="space-y-3 text-base">
                        <p><strong>Type:</strong> <span id="result-type" class="font-bold text-indigo-600"></span></p>
                        <p><strong>Confidence:</strong> <span id="result-confidence" class="font-bold text-green-600"></span></p>
                        <p><strong>Disposal:</strong> <span id="result-disposal" class="font-medium text-gray-700 block mt-1 bg-white p-2 rounded-lg border"></span></p>
                        <p><strong>Reason:</strong> <span id="result-reason" class="font-normal text-gray-600 block mt-1 bg-white p-2 rounded-lg border"></span></p>
                    </div>
                </div>

                <!-- List of supported waste types for context -->
                <div class="mt-6 text-sm text-gray-500 p-4 border-t border-gray-100">
                    <p class="font-semibold text-gray-700 mb-2">Supported Categories:</p>
                    <ul class="list-disc list-inside space-y-1 ml-2">
                        <li>Biodegradable Waste</li>
                        <li>Recyclable Waste</li>
                        <li>Non-Recyclable Waste</li>
                        <li>Hazardous Waste</li>
                        <li>Biomedical Waste</li>
                        <li>E-waste</li>
                    </ul>
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- API & Environment Setup ---
        // API key will be automatically provided by the Canvas environment.
        const apiKey = ""; 
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;
        
        // --- DOM Elements ---
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const fileSelectBtn = document.getElementById('file-select-btn');
        const cameraBtn = document.getElementById('camera-btn');
        const switchToUploadBtn = document.getElementById('switch-to-upload-btn');
        const captureBtn = document.getElementById('capture-btn');
        const classifyBtn = document.getElementById('classify-btn');
        
        const inputSection = document.getElementById('input-section');
        const cameraPreviewSection = document.getElementById('camera-preview-section');
        const cameraVideo = document.getElementById('camera-video');
        const cameraCanvas = document.getElementById('camera-canvas');
        const imagePreview = document.getElementById('image-preview');

        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const resultSection = document.getElementById('result-section');

        let currentImageBase64 = null;
        let currentImageMimeType = null;
        let cameraStream = null;

        // --- Utility Functions ---

        /**
         * Hides all dynamic content sections (loading, error, result)
         */
        function hideAllStates() {
            loadingIndicator.classList.add('hidden');
            errorMessage.classList.add('hidden');
            resultSection.classList.add('hidden');
            classifyBtn.classList.add('hidden');
            classifyBtn.disabled = true;
            errorText.textContent = '';
        }

        /**
         * Shows an error message in the dedicated UI section.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            hideAllStates();
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        /**
         * Switches the view between file upload and camera preview.
         * @param {'upload'|'camera'} mode 
         */
        function switchMode(mode) {
            hideAllStates();
            stopCamera();
            currentImageBase64 = null;
            imagePreview.classList.add('hidden');

            if (mode === 'upload') {
                inputSection.classList.remove('hidden');
                cameraPreviewSection.classList.add('hidden');
            } else if (mode === 'camera') {
                inputSection.classList.add('hidden');
                cameraPreviewSection.classList.remove('hidden');
                startCamera();
            }
        }

        /**
         * Displays the captured or selected image.
         * @param {string} base64 - Base64 data URL of the image.
         */
        function displayImagePreview(base64) {
            hideAllStates();
            imagePreview.src = base64;
            imagePreview.classList.remove('hidden');
            cameraVideo.classList.add('hidden');
            classifyBtn.classList.remove('hidden');
            classifyBtn.disabled = false;
        }

        /**
         * Starts the camera stream (prefers rear camera on mobile).
         */
        async function startCamera() {
            try {
                // Request camera stream, preferring the environment (rear) camera on mobile
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' }
                    }
                };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraVideo.classList.remove('hidden');
            } catch (err) {
                console.error("Camera access denied or error:", err);
                showError("Could not access camera. Please check permissions or use file upload.");
                switchMode('upload');
            }
        }

        /**
         * Stops the active camera stream.
         */
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        /**
         * Captures a frame from the video stream and sets it as the current image.
         */
        function capturePhoto() {
            if (!cameraStream) {
                showError("Camera stream is not active.");
                return;
            }

            const video = cameraVideo;
            const canvas = cameraCanvas;

            // Set canvas dimensions to match video stream
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert canvas content to a Base64 data URL
            const dataUrl = canvas.toDataURL('image/png');
            currentImageMimeType = 'image/png';
            currentImageBase64 = dataUrl.split(',')[1];
            
            // Show preview and enable classification
            displayImagePreview(dataUrl);
            stopCamera();
        }


        /**
         * Converts a File object to a Base64 string for API submission.
         * @param {File} file - The image file object.
         */
        function processFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showError("Please select a valid image file.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                currentImageMimeType = file.type;
                currentImageBase64 = dataUrl.split(',')[1];
                displayImagePreview(dataUrl);
            };
            reader.onerror = function() {
                showError("Failed to read the file.");
            };
            reader.readAsDataURL(file);
        }

        // --- API Communication ---

        /**
         * Helper function for exponential backoff during fetch requests.
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) {
                         // Throw to enter catch and retry loop
                         throw new Error(`Rate limit exceeded, retrying...`);
                    }
                    if (!response.ok) {
                        // Check for common error status codes
                        const errorBody = await response.json().catch(() => ({}));
                        const errorMsg = errorBody.error?.message || `API request failed with status ${response.status}.`;
                        throw new Error(errorMsg);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        /**
         * Calls the Gemini API to classify the uploaded/captured image.
         */
        async function classifyImage() {
            if (!currentImageBase64) {
                showError("No image selected or captured for classification.");
                return;
            }

            hideAllStates();
            loadingIndicator.classList.remove('hidden');

            const systemPrompt = `You are a world-class waste classification AI named NeuroBin. Analyze the provided image and classify the waste into one of these six categories: 'Biodegradable Waste', 'Recyclable Waste', 'Non-Recyclable Waste', 'Hazardous Waste', 'Biomedical Waste', or 'E-waste'. 
                                  Provide a brief, single-sentence reason for the classification and suggest the best disposal method. 
                                  Crucially, return the classification result as a single JSON object with the following schema. DO NOT include any explanatory text outside of the JSON block.`;

            const userPrompt = "Classify the waste in this image, provide a brief reason, and suggest the best disposal method.";
            
            const payload = {
                contents: [{ 
                    parts: [
                        { text: userPrompt },
                        { inlineData: { mimeType: currentImageMimeType, data: currentImageBase64 } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "type": { "type": "STRING", "description": "The classified waste category (e.g., 'Recyclable Waste')." },
                            "reason": { "type": "STRING", "description": "A brief reason for the classification." },
                            "disposal": { "type": "STRING", "description": "The optimal disposal method." },
                            "confidence": { "type": "STRING", "description": "A confidence score as a percentage string (e.g., '95%')." }
                        },
                        required: ["type", "reason", "disposal", "confidence"]
                    }
                }
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonString = candidate.content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);
                    displayResult(parsedJson);
                } else {
                    throw new Error("Invalid response structure or empty result from the API.");
                }

            } catch (error) {
                console.error("Classification Error:", error);
                // Check for API key error specifically
                if (error.message.includes("API key not valid")) {
                    showError("Authentication Failed: The provided API key is invalid or missing. Please check your environment setup.");
                } else {
                    showError(error.message || "An unexpected error occurred during classification. Please try again.");
                }
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Displays the classification result to the user.
         * @param {object} data - The parsed JSON result from the API.
         */
        function displayResult(data) {
            hideAllStates();
            
            // Safely extract data, providing defaults if needed
            const type = data.type || 'N/A';
            const confidence = data.confidence || 'N/A';
            const reason = data.reason || 'No reason provided.';
            const disposal = data.disposal || 'Disposal method unknown.';
            
            document.getElementById('result-type').textContent = type;
            document.getElementById('result-confidence').textContent = confidence;
            document.getElementById('result-reason').textContent = reason;
            document.getElementById('result-disposal').textContent = disposal;

            // Apply color coding based on a simplified type check for better visibility
            const typeElement = document.getElementById('result-type');
            typeElement.className = 'font-bold'; 
            if (type.toLowerCase().includes('recyclable')) {
                typeElement.classList.add('text-blue-600');
            } else if (type.toLowerCase().includes('hazardous') || type.toLowerCase().includes('biomedical') || type.toLowerCase().includes('e-waste')) {
                typeElement.classList.add('text-red-600');
            } else if (type.toLowerCase().includes('biodegradable')) {
                typeElement.classList.add('text-green-600');
            } else {
                typeElement.classList.add('text-gray-800');
            }

            resultSection.classList.remove('hidden');
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Setup initial state
            switchMode('upload');
        });

        // 1. File Input/Drop Zone Handling
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });

        dropZone.addEventListener('click', (e) => {
            // Only trigger file input if the click isn't on the button itself (which already handles it)
            if (e.target.id !== 'file-select-btn') {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        });

        // Drag and Drop events
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                processFile(e.dataTransfer.files[0]);
            }
        });


        // 2. Camera Button Handling
        cameraBtn.addEventListener('click', () => {
            switchMode('camera');
        });

        switchToUploadBtn.addEventListener('click', () => {
            switchMode('upload');
        });

        captureBtn.addEventListener('click', capturePhoto);
        
        // 3. Classification Button
        classifyBtn.addEventListener('click', classifyImage);

    </script>
</body>
</html>
